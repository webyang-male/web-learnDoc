### å¼‚æ­¥æ“ä½œå‰ç½®çŸ¥è¯†

#### JavaScriptå•çº¿ç¨‹

> JavaScriptä¸ºä»€ä¹ˆè¦è®¾è®¡æˆ<font style="color:gold;">å•çº¿ç¨‹</font>ï¼Ÿ
>
> é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥æ˜ç¡®çš„æ˜¯å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹è¿™ä¸¤ç§æ–¹å¼ï¼Œå¹¶ä¸æ˜¯è°ä¸€å®šå¥½æˆ–è€…è°ä¸€å®šä¸å¥½ï¼Œåªæ˜¯ä¸¤ç§ä¸åŒçš„æ–¹å¼ã€‚
>
> ç„¶åï¼Œæ¯ç§è¯­è¨€è®¾è®¡çš„æ–¹å¼ä¸€å®šæ˜¯å’Œä»–çš„ç”¨é€”æœ‰å…³çš„ï¼Œjsçš„ä¸»è¦ç”¨é€”å°±æ˜¯æ“ä½œdomï¼Œä¸ºäº†é¿å…æ“ä½œdomå†²çªé‚£ä¹ˆå•çº¿ç¨‹å°±æ¯”è¾ƒåˆé€‚ã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹å†åŠ ä¸€äº›é”çš„æ¦‚å¿µå¯ä»¥æ¥é¿å…å†²çªï¼Œä½†è¿™æ ·ä¼šå¢åŠ è¯­è¨€çš„å¤æ‚æ€§ã€‚æ‰€ä»¥jsåœ¨ä¸€å¼€å§‹è®¾è®¡çš„æ—¶å€™å°±è¢«è®¾è®¡æˆäº†å•çº¿ç¨‹ã€‚

![](https://cdn.jsdelivr.net/gh/webyang-male/yangimgs/JavaScriptSync-xmind.png)

````js
// 1 3 2
console.log(1)
setTimeout(() => {
    console.log(2)
}, 0)
console.log(3)
````

#### AjaxåŸç†ä¸Callback Hell

##### AjaxåŸç†

````js
// 1ã€åˆ›å»ºXMLHttpRequestå¯¹è±¡
var xmlhttp;
if (window.XMLHttpRequest) {
  xmlhttp = new XMLHttpRequest();
} else {
  // å…¼å®¹æ—©æœŸæµè§ˆå™¨
  xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
}
// 2ã€å‘é€è¯·æ±‚
xmlhttp.open("GET", url, true);
xmlhttp.send();
// 3ã€æœåŠ¡ç«¯å“åº”
xmlhttp.onreadystatechange = function () {
  if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
    var obj = JSON.parse(xmlhttp.responseText);
    console.log(obj);

  }
};
````

##### å°è£…

````js
function ajax(url, callback) {
    // 1ã€åˆ›å»ºXMLHttpRequestå¯¹è±¡
    var xmlhttp
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest()
    } else { // å…¼å®¹æ—©æœŸæµè§ˆå™¨
        xmlhttp = new ActiveXObject('Microsoft.XMLHTTP')
    }
    // 2ã€å‘é€è¯·æ±‚
    xmlhttp.open('GET', url, true)
    xmlhttp.send()
    // 3ã€æœåŠ¡ç«¯å“åº”
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            var obj = JSON.parse(xmlhttp.responseText)
            // console.log(obj)
            callback(obj)
        }
    }
}

// var url = 'http://musicapi.xiecheng.live/personalized'
// ajax(url, res => {
//     console.log(res)
// })
````

##### Callback Hell

å‡½æ•°æ˜¯å¼‚æ­¥è°ƒç”¨çš„ï¼Œå› ä¸ºæ“ä½œä¸æ˜¯ç«‹å³å®Œæˆçš„ï¼Œè€Œæ˜¯ä¹‹åæ‰ä¼šå®Œæˆã€‚

```js
ajax('/static/a.json')
// ä¸‹é¢çš„ä»£ç ä¸ä¼šç­‰åˆ°ajaxæ‰§è¡Œå®Œæ‰æ‰§è¡Œ
// ...
```

è¿™ä¸ªè¿‡ç¨‹å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œå¯æ˜¯å¦‚æœåœ¨å›è°ƒä¹‹åå†å›è°ƒå‘¢ï¼Ÿ

```js
ajax('static/a.json', res => {
    console.log(res)
    ajax('static/b.json', res => {
        console.log(res)
        ajax('static/c.json', res => {
            console.log(res)
        })
    })
})
```

å¦‚æœåµŒå¥—å˜å¤šï¼Œä»£ç å±‚æ¬¡å°±ä¼šå˜æ·±ï¼Œç»´æŠ¤éš¾åº¦ä¹Ÿéšä¹‹å¢åŠ ã€‚

è¿™å°±è¢«ç§°ä¸º â€œå›è°ƒåœ°ç‹±â€ æˆ–è€…â€œå›è°ƒæ·±æ¸Šâ€ã€‚

### Promise

#### åŸºæœ¬è¯­æ³•

Promise å°±æ˜¯ä¸ºäº†è§£å†³â€œå›è°ƒåœ°ç‹±â€é—®é¢˜çš„ï¼Œå®ƒå¯ä»¥å°†å¼‚æ­¥æ“ä½œçš„å¤„ç†å˜å¾—å¾ˆä¼˜é›…ã€‚å›è°ƒåœ°ç‹±ï¼Œä»£ç éš¾ä»¥ç»´æŠ¤ï¼Œ å¸¸å¸¸ç¬¬ä¸€ä¸ªçš„å‡½æ•°çš„è¾“å‡ºæ˜¯ç¬¬äºŒä¸ªå‡½æ•°çš„è¾“å…¥è¿™ç§ç°è±¡promiseå¯ä»¥æ”¯æŒå¤šä¸ªå¹¶å‘çš„è¯·æ±‚ï¼Œè·å–å¹¶å‘è¯·æ±‚ä¸­çš„æ•°æ®è¿™ä¸ªpromiseå¯ä»¥è§£å†³å¼‚æ­¥çš„é—®é¢˜ï¼Œæœ¬èº«ä¸èƒ½è¯´promiseæ˜¯å¼‚æ­¥çš„ã€‚

åˆ›å»ºPromiseå®ä¾‹:

````js
const promise = new Promise(function(resolve, reject) {
    // ... some code

    if ( /* å¼‚æ­¥æ“ä½œæˆåŠŸ */ ) {
        resolve(value)
    } else {
        reject(error)
    }
})
````

`````js
let p = new Promise((resolve, reject) => {
  console.log(1);
  resolve('zzy');
});
p.then((a) => {
  console.log(2);
  console.log(a);
});
console.log(3);
//1 3 2 zzy
`````

<img src="https://cdn.jsdelivr.net/gh/webyang-male/yangimgs/promise.png" data-origin="https://cdn.jsdelivr.net/gh/webyang-male/yangimgs/promise.png" alt="promiseçŠ¶æ€" class="medium-zoom-image promise" title="promiseçŠ¶æ€"> 

<div class="custom-block warning"><p class="custom-block-title">æ³¨æ„</p> <p>çŠ¶æ€è½¬åŒ–æ˜¯å•å‘çš„ï¼Œä¸å¯é€†è½¬ï¼Œå·²ç»ç¡®å®šçš„çŠ¶æ€ï¼ˆfulfilled/rejectedï¼‰æ— æ³•è½¬å›åˆå§‹çŠ¶æ€ï¼ˆpendingï¼‰ï¼Œè€Œä¸”åªèƒ½æ˜¯ä» pending åˆ° fulfilled æˆ–è€… rejected</p></div>

#### Promise.prototype.then()

**åŸºæœ¬è¯­æ³•**

> promise.then(onFulfilled, onRejected)

````js
let promise = new Promise(function(resolve, reject) {
    resolve('ä¼ é€’ç»™thençš„å€¼')
})
promise.then(function(value) {
    console.log(value)
}, function(error) {
    console.error(error)
})
````

è¿™æ®µä»£ç åˆ›å»ºä¸€ä¸ª Promise å¯¹è±¡ï¼Œå®šä¹‰äº†å¤„ç† onFulfilled å’Œ onRejected çš„å‡½æ•°ï¼ˆhandlerï¼‰ï¼Œç„¶åè¿”å›è¿™ä¸ª Promise å¯¹è±¡ã€‚

è¿™ä¸ª Promise å¯¹è±¡ä¼šåœ¨å˜ä¸º resolve æˆ–è€… reject çš„æ—¶å€™åˆ†åˆ«è°ƒç”¨ç›¸åº”æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚

- å½“ handler è¿”å›ä¸€ä¸ªæ­£å¸¸å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼ä¼šä¼ é€’ç»™ Promise å¯¹è±¡çš„ onFulfilled æ–¹æ³•ã€‚
- å®šä¹‰çš„ handler ä¸­äº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼åˆ™ä¼šä¼ é€’ç»™ Promise å¯¹è±¡çš„ onRejected æ–¹æ³•

#### Promise.prototype.catch()

æ•è·å¼‚å¸¸æ˜¯ç¨‹åºè´¨é‡ä¿éšœæœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ Promise å¯¹è±¡çš„ catch æ–¹æ³•æ¥æ•è·å¼‚æ­¥æ“ä½œè¿‡ç¨‹ä¸­å‡ºç°çš„ä»»ä½•å¼‚å¸¸ã€‚

**åŸºæœ¬è¯­æ³•**

> ```js
> p.catch(onRejected);
> 
> p.catch(function(reason) {
>    // æ‹’ç»
> });
> ```

````js
// æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå¤§å¤šæ•°æ—¶å€™å°†è°ƒç”¨catchæ–¹æ³•
var p1 = new Promise(function(resolve, reject) {
  throw 'Uh-oh!';
});

p1.catch(function(e) {
  console.log(e); // "Uh-oh!"
});

// åœ¨å¼‚æ­¥å‡½æ•°ä¸­æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šè¢«catchæ•è·åˆ°
var p2 = new Promise(function(resolve, reject) {
  setTimeout(function() {
    throw 'Uncaught Exception!';
  }, 1000);
});

p2.catch(function(e) {
  console.log(e); // ä¸ä¼šæ‰§è¡Œ
});

// åœ¨resolve()åé¢æŠ›å‡ºçš„é”™è¯¯ä¼šè¢«å¿½ç•¥
var p3 = new Promise(function(resolve, reject) {
  resolve();
  throw 'Silenced Exception!';
});

p3.catch(function(e) {
   console.log(e); // ä¸ä¼šæ‰§è¡Œ
});
````

<div class="custom-block warning"><p class="custom-block-title">æ³¨æ„</p> <p>ä¸å»ºè®®åœ¨ Promise å†…éƒ¨ä½¿ç”¨ throw æ¥è§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>reject(new Error())</code> çš„æ–¹å¼æ¥åšï¼Œå› ä¸º throw çš„æ–¹å¼å¹¶æ²¡æœ‰æ”¹å˜ Promise çš„çŠ¶æ€</p></div>

````js
function test() {
    return new Promise((resolve, reject) => {
        reject(new Error('es'))
    })
}

test().catch((e) => {
    console.log(e.message) // es
})
````

#### é™æ€æ–¹æ³•

##### Promise.resolve()

ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ `new Promise()`æ¥åˆ›å»º Promise å¯¹è±¡ï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä¼šå­¦ä¹ å¦‚ä½•ä½¿ç”¨ Promise.resolve å’Œ Promise.reject è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

é™æ€æ–¹æ³• Promise.resolve(value) å¯ä»¥è®¤ä¸ºæ˜¯ new Promise() æ–¹æ³•çš„å¿«æ·æ–¹å¼ã€‚

æ¯”å¦‚ Promise.resolve(18) å¯ä»¥è®¤ä¸ºæ˜¯ä»¥ä¸‹ä»£ç çš„è¯­æ³•ç³–ã€‚

```js
new Promise(function(resolve) {
    resolve(18)
})
```

é¢ then é‡Œæ‰€æŒ‡å®šçš„ onFulfilled å‡½æ•°ã€‚

æ–¹æ³• Promise.resolve(value) çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ª`Promise` å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢é‚£æ ·æ¥ç€å¯¹å…¶è¿”å›å€¼è¿›è¡Œ` .then `è°ƒç”¨ã€‚

```js
Promise.resolve(18).then(function(value) {
    console.log(value)
})
```

`Promise.resolve` ä½œä¸º new Promise() çš„å¿«æ·æ–¹å¼ï¼Œåœ¨è¿›è¡Œ Promise å¯¹è±¡çš„åˆå§‹åŒ–æˆ–è€…ç¼–å†™æµ‹è¯•ä»£ç çš„æ—¶å€™éƒ½éå¸¸æ–¹ä¾¿ã€‚

##### Promise.reject()

Promise.reject(error) æ˜¯å’Œ Promise.resolve(value) ç±»ä¼¼çš„é™æ€æ–¹æ³•ï¼Œæ˜¯ new Promise() æ–¹æ³•çš„å¿«æ·æ–¹å¼ã€‚

æ¯”å¦‚` Promise.reject(new Error("å‡ºé”™äº†")) `å°±æ˜¯ä¸‹é¢ä»£ç çš„è¯­æ³•ç³–å½¢å¼ã€‚

```js
new Promise(function(resolve, reject) {
    reject(new Error('å‡ºé”™äº†'))
})
```

è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯è°ƒç”¨è¯¥Promise å¯¹è±¡é€šè¿‡thenæŒ‡å®šçš„ onRejected å‡½æ•°ï¼Œå¹¶å°†é”™è¯¯ï¼ˆErrorï¼‰å¯¹è±¡ä¼ é€’ç»™è¿™ä¸ª onRejected å‡½æ•°ã€‚

```js
Promise.reject(new Error('BOOM!')
```

##### Promise.all()

**åŸºæœ¬è¯­æ³•**

> Promise.all(promiseArray)

**ç¤ºä¾‹**

```js
var p1 = Promise.resolve(1)
var p2 = Promise.resolve(2)
var p3 = Promise.resolve(3)
Promise.all([p1, p2, p3]).then(function(results) {
    console.log(results) // [1, 2, 3]
})
```

Promise.all ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒå¯ä»¥ä½¿ç”¨ Promise å®ä¾‹çš„æ‰€æœ‰æ–¹æ³•ã€‚å‚æ•°ä¼ é€’promiseæ•°ç»„ä¸­æ‰€æœ‰çš„ Promise å¯¹è±¡éƒ½å˜ä¸ºresolveçš„æ—¶å€™ï¼Œè¯¥æ–¹æ³•æ‰ä¼šè¿”å›ï¼Œ æ–°åˆ›å»ºçš„ Promise åˆ™ä¼šä½¿ç”¨è¿™äº› promise çš„å€¼ã€‚

<font style="color:darkorange;">å¦‚æœå‚æ•°ä¸­çš„ä»»ä½•ä¸€ä¸ªpromiseä¸ºrejectçš„è¯ï¼Œåˆ™æ•´ä¸ªPromise.allè°ƒç”¨ä¼šç«‹å³ç»ˆæ­¢ï¼Œå¹¶è¿”å›ä¸€ä¸ªrejectçš„æ–°çš„ Promise å¯¹è±¡ã€‚</font>

ç”±äºå‚æ•°æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç”± Promise.resolve åŒ…è£…ï¼ˆwrapï¼‰çš„ï¼Œæ‰€ä»¥Promise.all å¯ä»¥å¤„ç†ä¸åŒç±»å‹çš„ Promise å¯¹è±¡ã€‚

##### Promise.race()

**åŸºæœ¬è¯­æ³•**

> Promise.race(promiseArray)

**ç¤ºä¾‹**

```js
var p1 = Promise.resolve(1)
var p2 = Promise.resolve(2)
var p3 = Promise.resolve(3)
Promise.race([p1, p2, p3]).then(function(value) {
    console.log(value) // 1
})
```

Promise.race ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚

å‚æ•° promise æ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ª Promise å¯¹è±¡å¦‚æœå˜ä¸º resolve æˆ–è€… reject çš„è¯ï¼Œ è¯¥å‡½æ•°å°±ä¼šè¿”å›ï¼Œå¹¶ä½¿ç”¨è¿™ä¸ª Promise å¯¹è±¡çš„å€¼è¿›è¡Œ resolve æˆ–è€… rejectã€‚

**å®ä¾‹**

å›¾ç‰‡ä¸Šä¼ 

````js
const imgArr = ['1.jpg', '2.jpg', '3.jpg']
let promiseArr = []
imgArr.forEach(item => {
    promiseArr.push(new Promise((resolve, reject) => {
        // å›¾ç‰‡ä¸Šä¼ çš„æ“ä½œ
        resolve()
    }))
})
Promise.all(promiseArr).then(res => {
    // æ’å…¥æ•°æ®åº“çš„æ“ä½œ
    console.log('å›¾ç‰‡å…¨éƒ¨ä¸Šä¼ å®Œæˆ')
})

function getImg() {
    return new Promise((resolve, reject) => {
        let img = new Image()
        img.onload = function () {
            resolve(img)
        }
        // img.src = 'http://www.xxx.com/xx.jpg'
        img.src = 'https://www.imooc.com/static/img/index/logo.png'
    })
}

function timeout() {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            reject('å›¾ç‰‡è¯·æ±‚è¶…æ—¶')
        }, 2000)
    })
}

Promise.race([getImg(), timeout()]).then(res => {
    console.log(res)
}).catch(err => {
    console.log(err)
})
````



#### ajaxæ”¹é€ 

````js
function ajax(url, successCallback, failCallback) {
    // 1ã€åˆ›å»ºXMLHttpRequestå¯¹è±¡
    var xmlhttp
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest()
    } else { // å…¼å®¹æ—©æœŸæµè§ˆå™¨
        xmlhttp = new ActiveXObject('Microsoft.XMLHTTP')
    }
    // 2ã€å‘é€è¯·æ±‚
    xmlhttp.open('GET', url, true)
    xmlhttp.send()
    // 3ã€æœåŠ¡ç«¯å“åº”
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            var obj = JSON.parse(xmlhttp.responseText)
            // console.log(obj)
            successCallback && successCallback(obj)
        } else if (xmlhttp.readyState === 4 && xmlhttp.status === 404) {
            failCallback && failCallback(xmlhttp.statusText)
        }
    }
}

// new Promise((resolve, reject) => {
//     ajax('static/a.json', res => {
//         console.log(res)
//         resolve()
//     })
// }).then(res => {
//     console.log('aæˆåŠŸ')
//     return new Promise((resolve, reject) => {
//         ajax('static/b.json', res => {
//             console.log(res)
//             resolve()
//         })
//     })
// }).then(res => {
//     console.log('bæˆåŠŸ')
//     return new Promise((resolve, reject) => {
//         ajax('static/c.json', res => {
//             console.log(res)
//             resolve()
//         })
//     })
// }).then(res => {
//     console.log('cæˆåŠŸ')
// })

function getPromise(url) {
    return new Promise((resolve, reject) => {
        ajax(url, res => {
            resolve(res)
        }, err => {
            reject(err)
        })
    })
}


getPromise('static/a.json')
    .then(res => {
        console.log(res)
        return getPromise('static/b.json')
    }).then(res => {
        console.log(res)
        return getPromise('static/c.json')
    }).then(res => {
        console.log(res)
    }).catch(err => {
        console.log(err)
    })

````

#### ã€è®¨è®ºé¢˜ã€‘

ğŸ”¹**Promise ä¸­reject å’ŒcatchåŒºåˆ«**

Promiseçš„å‚æ•°çš„å‡½æ•°ä¸­æœ‰rejectæ¥å¤„ç†å¤±è´¥æƒ…å†µï¼Œcatchæ–¹æ³•ä¹Ÿå¯ä»¥å¤„ç†å¤±è´¥æƒ…å†µï¼Œé‚£ä¹ˆä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

##### rejcect

- æ˜¯Promiseçš„é™æ€æ–¹æ³•
- å¯¹åº”thenä¸­ç¬¬äºŒä¸ªå‚æ•°,å¦‚æœthenä¸­æ²¡æœ‰å†™ç¬¬äºŒä¸ªå›è°ƒï¼Œåˆ™è¿›å…¥catch
- åªèƒ½æ•è·åˆ°Promiseå¯¹è±¡ä¸­å‡½æ•°çš„é”™è¯¯
- å¯ä»¥å°†promise çš„çŠ¶æ€æ”¹ä¸º rejected

##### catch

- æ˜¯Promiseå®ä¾‹çš„æ–¹æ³•, å¯¹é”™è¯¯ä¿¡æ¯ç»Ÿä¸€ç®¡ç†
- å¯ä»¥æ•è·åˆ°è°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰å¼‚å¸¸
- æ–­ç½‘æƒ…å†µè¿›å…¥catch
- å¯ä»¥é€šè¿‡ reject å’Œ throw new error æ¥è§¦å‘ï¼Œä½†åªæœ‰é€šè¿‡ reject æ¥è§¦å‘ï¼Œæ‰èƒ½æŠŠpromiseçŠ¶æ€æ”¹ä¸ºrejected

> - `reject`æ˜¯`Promise`çš„é™æ€æ–¹æ³•ï¼Œ`catch`æ˜¯`Promise`å®ä¾‹çš„æ–¹æ³•ï¼›
> - `reject`åªèƒ½æ•è·åˆ°Promiseå¯¹è±¡ä¸­çš„é”™è¯¯ï¼Œ`catch`å¯ä»¥æ•è·åˆ°è°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰å¼‚å¸¸ã€‚

ğŸ”¹**Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œè¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Ÿ**

new Promise()è°ƒç”¨äº†Promiseçš„æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆnew Promise()çš„å‚æ•°å‡½æ•°é‡Œçš„ä»£ç æ˜¯åŒæ­¥æ‰§è¡Œè¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œå‘¢ï¼Ÿthenæ–¹æ³•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å‘¢ï¼Ÿ

````js
//æ‰§è¡Œç»“æœ 1 2 4 3
const promise = new Promise((resolve, reject) => {
  console.log(1)
  resolve()
  console.log(2)
})

promise.then(() => {
  console.log(3)
})

console.log(4)
````

### Generator

é€šä¿—çš„è®² Generators æ˜¯å¯ä»¥ç”¨æ¥æ§åˆ¶è¿­ä»£å™¨çš„å‡½æ•°ã€‚å®ƒä»¬å¯ä»¥æš‚åœï¼Œç„¶ååœ¨ä»»ä½•æ—¶å€™æ¢å¤ã€‚

**1. å¸¸è§„å¾ªç¯**

```js
for (let i = 0; i < 5; i += 1) {
    console.log(i)
}
// this will return immediately 0 -> 1 -> 2 -> 3 -> 4
```

**2. åˆ©ç”¨ Generator**

```js
function* generatorForLoop() {
    for (let i = 0; i < 5; i += 1) {
        yield console.log(i)
    }
}

const genForLoop = generatorForLoop()

console.log(genForLoop.next()) // first console.log - 0
console.log(genForLoop.next()) // 1
console.log(genForLoop.next()) // 2
console.log(genForLoop.next()) // 3
console.log(genForLoop.next()) // 4
```

å¯¹æ¯”ä¸‹ä»£ç ï¼Œå¸¸è§„çš„å¾ªç¯åªèƒ½ä¸€æ¬¡éå†å®Œæ‰€æœ‰å€¼ï¼ŒGenerator å¯ä»¥é€šè¿‡è°ƒç”¨ next æ–¹æ³•æ‹¿åˆ°ä¾æ¬¡éå†çš„å€¼ï¼Œè®©éå†çš„æ‰§è¡Œå˜å¾—â€œå¯æ§â€ã€‚

#### åŸºæœ¬è¯­æ³•

##### å®šä¹‰

```js
function* gen() {
    yield 1
    yield 2
    yield 3
}

let g = gen()
// "Generator { }"
```

Generator çš„å®šä¹‰æ–¹æ³•ï¼Œæœ‰å‡ ä¸ªç‚¹å€¼å¾—æ³¨æ„ï¼š

1. æ¯”æ™®é€šå‡½æ•°å¤šä¸€ä¸ª *
2. å‡½æ•°å†…éƒ¨ç”¨ yield æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œçš„â€œæš‚åœâ€
3. å‡½æ•°çš„è¿”å›å€¼é€šè¿‡è°ƒç”¨ next æ¥â€œæ¢å¤â€ç¨‹åºæ‰§è¡Œ

<div class="custom-block danger"><p class="custom-block-title">æ³¨æ„</p> <p>Generator å‡½æ•°çš„å®šä¹‰ä¸èƒ½ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œå¦åˆ™ä¼šè§¦å‘ SyntaxError é”™è¯¯</p></div>

````js
let generator = * () => {} // SyntaxError
let generator = () * => {} // SyntaxError
let generator = ( * ) => {} // SyntaxError
````

##### yield è¡¨è¾¾å¼

?> yield å…³é”®å­—ç”¨æ¥æš‚åœå’Œæ¢å¤ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°

ğŸ“˜å…³äº yield è¡¨è¾¾å¼ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š

1. yield è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ undefinedï¼Œä½†æ˜¯éå†å™¨å¯¹è±¡çš„ next æ–¹æ³•å¯ä»¥ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ã€‚

````js
  function* gen() {
      let val
      val = yield 1
      console.log( `1:${val}` ) // 1:undefined
      val = yield 2
      console.log( `2:${val}` ) // 2:undefined
      val = yield 3
      console.log( `3:${val}` ) // 3:undefined
  }

  var g = gen()

  console.log(g.next()) // {value: 1, done: false}
  console.log(g.next()) // {value: 2, done: false}
  console.log(g.next()) // {value: 3, done: false}
  console.log(g.next()) // {value: undefined, done: true}
````

ä»è¿™ä¸ªä»£ç å¯ä»¥çœ‹å‡ºæ¥ï¼Œyield è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ undefinedã€‚

2. yeild * æ˜¯å§”æ‰˜ç»™å¦ä¸€ä¸ªéå†å™¨å¯¹è±¡æˆ–è€…å¯éå†å¯¹è±¡

````js
 function* gen() {
      let val
      val = yield 1
      console.log( `1:${val}` ) // 1:undefined
      val = yield 2
      console.log( `2:${val}` ) // 2:undefined
      val = yield [3, 4, 5]
      console.log( `3:${val}` ) // 3:undefined
  }
````

3.Generator å¯¹è±¡çš„ next æ–¹æ³•ï¼Œé‡åˆ° yield å°±æš‚åœï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…æ‹¬ä¸¤ä¸ªå±æ€§ï¼švalue å’Œ doneã€‚

å‚è€ƒæ­¥éª¤1 çš„ä»£ç å¯ä»¥æ˜ç¡®çœ‹å‡ºæ¥ï¼Œæ‰§è¡Œç¬¬ä¸€å¥ ```g.next` ``gen ä»£ç æ‰§è¡Œåˆ° yield 1ï¼Œç¨‹åºæš‚åœï¼Œæ­¤æ—¶è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼š{value: 1, done: false}

**å®ä¾‹**

````js
function* gen(x) {
    let y = 2 * (yield(x + 1))
    let z = yield(y / 3)
    return x + y + z
}
// let g = gen(5)
// console.log(g.next()) // 6
// console.log(g.next()) // NaN
// console.log(g.next()) // NaN

let g = gen(5)
console.log(g.next()) // 6
console.log(g.next(12)) // y=24  8
console.log(g.next(13)) // z=13 x=5 42
````

#### åº”ç”¨åœºæ™¯

##### åœºæ™¯1

å¼‚æ­¥æ“ä½œ,æŒ‰é¡ºåºè¯»å–a.jsonã€b.jsonã€c.json

````js
function ajax(url, callback) {
    // 1ã€åˆ›å»ºXMLHttpRequestå¯¹è±¡
    var xmlhttp
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest()
    } else { // å…¼å®¹æ—©æœŸæµè§ˆå™¨
        xmlhttp = new ActiveXObject('Microsoft.XMLHTTP')
    }
    // 2ã€å‘é€è¯·æ±‚
    xmlhttp.open('GET', url, true)
    xmlhttp.send()
    // 3ã€æœåŠ¡ç«¯å“åº”
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            var obj = JSON.parse(xmlhttp.responseText)
            // console.log(obj)
            callback(obj)
        }
    }
}

function request(url) {
    ajax(url, res => {
        getData.next(res)
    })
}

function* gen() {
    let res1 = yield request('static/a.json')
    console.log(res1)
    let res2 = yield request('static/b.json')
    console.log(res2)
    let res3 = yield request('static/c.json')
    console.log(res3)
}
let getData = gen()
getData.next()
````

##### åœºæ™¯2

æˆ‘ä»¬ç»å¸¸ç©ä¸€äº›å°æ¸¸æˆï¼Œæ¯”å¦‚æ•°æ•°å­—ï¼Œæ•²7ï¼Œåˆ°7å’Œ7çš„å€æ•°ï¼Œæ— é™å¾ªç¯è½¬åœˆå»æ•°æ•°

`````js
function* count(x = 1) {
    while (true) {
        if (x % 7 === 0) {
            yield x
        }
        x++
    }
}
// es5ä¸­å°±æ˜¯ä¸ªæ­»å¾ªç¯ å› ä¸ºes5çš„å¾ªç¯éœ€è¦æœ‰ä¸ªç»ˆæ­¢å€¼ï¼Œä½†æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚æ²¡æœ‰ç»ˆæ­¢ï¼Œä¸€ç›´åœ¨æ•°æ•°
let n = count()
console.log(n.next().value)
console.log(n.next().value)
console.log(n.next().value)
console.log(n.next().value)
console.log(n.next().value)
console.log(n.next().value)
`````

### Iterator

>
> Iteratoræ˜¯ä¸€ç§æ¥å£æœºåˆ¶ï¼Œä¸ºå„ç§ä¸åŒçš„æ•°æ®ç»“æ„æä¾›ç»Ÿä¸€è®¿é—®çš„æœºåˆ¶ã€‚
>
> ä¸»è¦ä¾›for...ofä½¿ç”¨ã€‚
>
> ä¸€å¥è¯:ä½¿å¾—ä¸æ”¯æŒéå†çš„æ•°æ®ç»“æ„â€œå¯éå†â€

**ç¤ºä¾‹**

````js
let courses = {
    allCourse: {
        frontend: ['ES', 'å°ç¨‹åº', 'Vue', 'React'],
        backend: ['Java', 'Python', 'SpringBoot'],
        webapp: ['Android', 'IOS']
    }
}
for (let c of courses) {
    console.log(c)
}
````

<div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>è¿™ä¸ªéå†é‡åˆ°äº†æŠ¥é”™ï¼šUncaught TypeError: authors is not iterable</p></div>

#### åŸºæœ¬è¯­æ³•

Iterator å°±æ˜¯ ES6 ä¸­ç”¨æ¥å®ç°è‡ªå®šä¹‰éå†çš„æ¥å£ï¼ŒæŒ‰ç…§ä¸Šè¿°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸‹è¿™ä¸ªæ¥å£ï¼š

````js
let courses = {
  allCourse: {
    frontend: ["ES", "å°ç¨‹åº", "Vue", "React"],
    backend: ["Java", "Python", "SpringBoot"],
    webapp: ["Android", "IOS"],
  },
};

// å¯è¿­ä»£åè®®ï¼šSymbol.iterator
// è¿­ä»£å™¨åè®®ï¼šreturn { next(){ return{value, done} }}
courses[Symbol.iterator] = function () {
  let allCourse = this.allCourse;
  let keys = Reflect.ownKeys(allCourse);
  let values = [];
  return {
    next() {
      if (!values.length) {
        if (keys.length) {
          values = allCourse[keys[0]];
          keys.shift();
        }
      }
      return {
        done: !values.length,
        value: values.shift(),
      };
    },
  };
};

//è¿™ä¸ªä»£ç åœ¨æ•°æ®ç»“æ„ä¸Šéƒ¨ç½²äº† Iterator æ¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ for...of æ¥éå†ä»£ç äº†ï¼š
for (let c of courses) {
  console.log(c);
}
````

#### ç†è§£ Iterator 

**1. è¿­ä»£å™¨åè®®**

| å±æ€§ |                              å€¼                              | å¿…é€‰ |
| :--: | :----------------------------------------------------------: | :--: |
| next | è¿”å›ä¸€ä¸ªå¯¹è±¡çš„æ— å‚å‡½æ•°ï¼Œè¢«è¿”å›å¯¹è±¡æ‹¥æœ‰ä¸¤ä¸ªå±æ€§ï¼šdone å’Œ value |  Y   |

è¿™æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼šå¯è¿­ä»£åè®®ã€è¿­ä»£å™¨åè®®ã€‚é€šä¿—çš„è®²ï¼Œè¿­ä»£å™¨åè®®è¦æ±‚ç¬¦åˆä»¥ä¸‹æ¡ä»¶ï¼š

- é¦–å…ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡
- å…¶æ¬¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«ä¸€ä¸ªæ— å‚å‡½æ•° next
- æœ€åï¼Œnext è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡åŒ…å« done å’Œ value å±æ€§ã€‚å…¶ä¸­ done è¡¨ç¤ºéå†æ˜¯å¦ç»“æŸï¼Œvalue è¿”å›å½“å‰éå†çš„å€¼ã€‚

!> å¦‚æœ next å‡½æ•°è¿”å›ä¸€ä¸ªéå¯¹è±¡å€¼ï¼ˆæ¯”å¦‚falseå’Œundefined) ä¼šå±•ç¤ºä¸€ä¸ª TypeError ("iterator.next() returned a non-object value") çš„é”™è¯¯

**2. å¯è¿­ä»£åè®®**

å¯è¿­ä»£åè®®å…è®¸ JavaScript å¯¹è±¡å»å®šä¹‰æˆ–å®šåˆ¶å®ƒä»¬çš„è¿­ä»£è¡Œä¸º, ä¾‹å¦‚ï¼ˆå®šä¹‰ï¼‰åœ¨ä¸€ä¸ª for..of ç»“æ„ä¸­ä»€ä¹ˆå€¼å¯ä»¥è¢«å¾ªç¯ï¼ˆå¾—åˆ°ï¼‰ã€‚ä¸€äº›å†…ç½®ç±»å‹éƒ½æ˜¯å†…ç½®çš„å¯è¿­ä»£ç±»å‹å¹¶ä¸”æœ‰é»˜è®¤çš„è¿­ä»£è¡Œä¸º, æ¯”å¦‚ Array or Map, å¦ä¸€äº›ç±»å‹åˆ™ä¸æ˜¯ (æ¯”å¦‚Object) ã€‚

ä¸ºäº†å˜æˆå¯è¿­ä»£å¯¹è±¡ï¼Œ ä¸€ä¸ªå¯¹è±¡å¿…é¡»å®ç° `@iterator `æ–¹æ³•, æ„æ€æ˜¯è¿™ä¸ªå¯¹è±¡ï¼ˆæˆ–è€…å®ƒåŸå‹é“¾ prototype chain ä¸Šçš„æŸä¸ªå¯¹è±¡ï¼‰å¿…é¡»æœ‰ä¸€ä¸ªåå­—æ˜¯ Symbol.iterator çš„å±æ€§:

|       å±æ€§        |                        å€¼                        | å¿…é€‰ |
| :---------------: | :----------------------------------------------: | :--: |
| [Symbol.iterator] | è¿”å›ä¸€ä¸ªå¯¹è±¡çš„æ— å‚å‡½æ•°ï¼Œè¢«è¿”å›å¯¹è±¡ç¬¦åˆè¿­ä»£å™¨åè®® |  Y   |

å¦‚æœè®©ä¸€ä¸ªå¯¹è±¡æ˜¯å¯éå†çš„ï¼Œå°±è¦éµå®ˆå¯è¿­ä»£åè®®ï¼Œè¯¥åè®®è¦æ±‚å¯¹è±¡è¦éƒ¨ç½²ä¸€ä¸ªä»¥ Symbol.iterator ä¸º key çš„é”®å€¼å¯¹ï¼Œè€Œ value å°±æ˜¯ä¸€ä¸ªæ— å‚å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å¯¹è±¡è¦éµå®ˆè¿­ä»£å™¨åè®®ã€‚

#### Generator

ç†Ÿæ‚‰äº† Generator ä¹‹åï¼Œå‘ç°å®ƒæ˜¯<font style="color:#1b91ff;">å¤©ç„¶æ»¡è¶³å¯è¿­ä»£åè®®</font>çš„ã€‚ä¸Šè¿°çš„ä»£ç æˆ‘ä»¬å¯ä»¥ç”¨ Generator æ¥å®ç°ï¼š

````js
// generator
courses[Symbol.iterator] = function* () {
    let allCourse = this.allCourse
    let keys = Reflect.ownKeys(allCourse)
    let values = []
    while (1) {
        if (!values.length) {
            if (keys.length) {
                values = allCourse[keys[0]]
                keys.shift()
                yield values.shift()
            } else {
                return false
            }
        }else{
            yield values.shift()
        }
    }
}

for (let c of courses) {
    console.log(c)
}
````

### Module

#### export

æ¨¡å—åŠŸèƒ½ä¸»è¦ç”±ä¸¤ä¸ªå‘½ä»¤æ„æˆï¼šexportå’Œimportã€‚exportå‘½ä»¤ç”¨äºè§„å®šæ¨¡å—çš„å¯¹å¤–æ¥å£ï¼Œimportå‘½ä»¤ç”¨äºè¾“å…¥å…¶ä»–æ¨¡å—æä¾›çš„åŠŸèƒ½ã€‚

ä¸€ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„æ‰€æœ‰å˜é‡ï¼Œå¤–éƒ¨æ— æ³•è·å–ã€‚å¦‚æœä½ å¸Œæœ›å¤–éƒ¨èƒ½å¤Ÿè¯»å–æ¨¡å—å†…éƒ¨çš„æŸä¸ªå˜é‡ï¼Œå°±å¿…é¡»ä½¿ç”¨exportå…³é”®å­—è¾“å‡ºè¯¥å˜é‡ã€‚

##### å¯¼å‡ºå˜é‡æˆ–è€…å¸¸é‡

```js
  export const name = 'hello'
  export let addr = 'BeiJing City'
  export var list = [1, 2, 3]
```

æˆ–è€…

```js
  const name = 'hello'
  let addr = 'BeiJing City'
  var list = [1, 2, 3]
  export {
      name,
      addr,
      list
  }
```

##### å¯¼å‡ºå‡½æ•°

```js
  export function say(content) {
      console.log(content)
  }
  export function run() {
      console.log('run')
  }
```

æˆ–è€…

```js
  const say = (content) => {
      console.log(content)
  }
  let run = () => {
      console.log('run')
  }
  export {
      say,
      run
  }
```

##### å¯¼å‡º Object

```js
  export ({
      code: 0,
      message: 'success'
  })
```

æˆ–è€…

```js
  let data = {
      code: 0,
      message: 'success'
  }
  export {
      data
  }
```

##### å¯¼å‡º Class

```js
  class Test {
      constructor() {
          this.id = 2
      }
  }
  export {
      Test
  }
```

æˆ–è€…

```js
  export class Test {
      constructor() {
          this.id = 2
      }
  }
```

#### as

å¦‚æœæƒ³ä¸ºè¾“å…¥çš„å˜é‡é‡æ–°å–ä¸€ä¸ªåå­—ï¼Œimportå‘½ä»¤è¦ä½¿ç”¨aså…³é”®å­—ï¼Œå°†è¾“å…¥çš„å˜é‡é‡å‘½åã€‚

```js
  const name = 'hello'
  let addr = 'BeiJing City'
  var list = [1, 2, 3]
  export {
      name as cname,
      addr as caddr,
      list
  }
```

#### import

ä½¿ç”¨exportå‘½ä»¤å®šä¹‰äº†æ¨¡å—çš„å¯¹å¤–æ¥å£ä»¥åï¼Œå…¶ä»– JS æ–‡ä»¶å°±å¯ä»¥é€šè¿‡importå‘½ä»¤åŠ è½½è¿™ä¸ªæ¨¡å—ã€‚

1.ç›´æ¥å¯¼å…¥

å‡è®¾å¯¼å‡ºæ¨¡å— A æ˜¯è¿™æ ·çš„ï¼š

```js
  const name = 'hello'
  let addr = 'BeiJing City'
  var list = [1, 2, 3]
  export {
      name as cname,
      addr as caddr
  }
  export default list
```

åˆ™å¯¼å…¥ï¼š

```js
  import list, {
      cname,
      caddr
  } from A
```

2.ä¿®æ”¹å¯¼å…¥åç§°

```js
  import list, {
      cname as name,
      caddr
  } from A
```

3.æ‰¹é‡å¯¼å…¥

```js
  import list, * as mod from A
  console.log(list)
  console.log(mod.cname)
  console.log(mod.caddr)
```
